<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Password List</title>
    <script>
        var _data = {
            passwordList: [],

            createPassword: function(label, user, password, notes, createdOn, modifiedOn) {
                var now = new Date();
                var passwordItem = {
                    label: label || "",
                    user: user || "",
                    password: password || "",
                    notes: notes || "",
                    createdOn: createdOn || now,
                    modifiedOn: modifiedOn || now
                };
                passwordItem.id = passwordItem.createdOn.valueOf(); // Use created on as id.
                this.passwordList.push(passwordItem);

                return passwordItem;
            },

            deletePassword: function(index) {
                this.passwordList.splice(index, 1);
            },

            getPassword: function(id) {
                for (var i = 0; i < this.passwordList.length; ++i) {
                    if (id === this.passwordList[i].id) {
                        return this.passwordList[i];
                    }
                }
            },

            updatePassword: function(id, label, user, password, notes) {
                var passwordItem = this.getPassword(id);

                if (passwordItem) {
                    passwordItem.label = label;
                    passwordItem.user = user;
                    passwordItem.password = password;
                    passwordItem.notes = notes;
                    passwordItem.modifiedOn = new Date();
                }

                return passwordItem;
            }
        };

        var _iv = null;
        var _keyFile = null;

        var _view = {
            addPasswordToList: function(passwordItem) {
                // Create and add a table row.
                var tbody = document.querySelector("#passwordList tbody");
                var newRow = tbody.insertRow(-1);
                newRow.dataset.id = passwordItem.id;
                newRow.insertCell(0).innerHTML = passwordItem.label;
                newRow.insertCell(1).innerHTML = passwordItem.user;
                newRow.insertCell(2).innerHTML = passwordItem.password;
                newRow.insertCell(3).innerHTML = passwordItem.notes;
                newRow.insertCell(4).innerHTML = passwordItem.createdOn.toLocaleString();
                newRow.insertCell(5).innerHTML = passwordItem.modifiedOn.toLocaleString();

                // var showHideCell = newRow.insertCell(4);
                // showHideCell.innerHTML = '<input type="checkbox" />';
                // showHideCell.firstChild.addEventListener("change", showHideHandler, false);

                var deleteCell = newRow.insertCell(6);
                deleteCell.innerHTML = "<button>Delete</button>";
                deleteCell.firstChild.addEventListener("click", _view.onDeletePassword, false);

                var editCell = newRow.insertCell(7);
                editCell.innerHTML = "<button>Edit</button>";
                editCell.firstChild.addEventListener("click", _view.onEditPassword, false);
            },

            // Begin: Event Handlers
            onAddPassword: function(e) {                
                // Create password item from the form inputs.
                var passwordItem = _data.createPassword(
                    document.getElementById("passwordFormLabel").value,
                    document.getElementById("passwordFormUser").value,
                    document.getElementById("passwordFormPassword").value,
                    document.getElementById("passwordFormNotes").value);

                _view.addPasswordToList(passwordItem);

                // Clear user input.
                document.getElementById("passwordForm").reset();
            },

            onDeletePassword: function(e) {
                var row = e.target.parentNode.parentNode;
                row.parentNode.removeChild(row);
            },

            onEditPassword: function(e) {
                var row = e.target.parentNode.parentNode;
                var passwordItem = _data.getPassword(parseInt(row.dataset.id));

                if (passwordItem) {
                    document.getElementById("passwordFormIndex").value = row.rowIndex;
                    document.getElementById("passwordFormId").value = passwordItem.id;
                    document.getElementById("passwordFormLabel").value = passwordItem.label;
                    document.getElementById("passwordFormUser").value = passwordItem.user;
                    document.getElementById("passwordFormPassword").value = passwordItem.password;
                    document.getElementById("passwordFormNotes").value = passwordItem.notes;
                }
            },

            onApplyEditPassword: function(e) {
                // TODO: Validate the values.
                var rowIndex = parseInt(document.getElementById("passwordFormIndex").value);
                var passwordId = parseInt(document.getElementById("passwordFormId").value);

                // Update the password item data.
                var passwordItem = _data.updatePassword(
                    passwordId,
                    document.getElementById("passwordFormLabel").value,
                    document.getElementById("passwordFormUser").value,
                    document.getElementById("passwordFormPassword").value,
                    document.getElementById("passwordFormNotes").value);

                if (passwordItem) {
                    var row = document.getElementById("passwordList").rows[rowIndex];
                    // Refresh the password in the table.
                    row.cells[0].innerHTML = passwordItem.label;
                    row.cells[1].innerHTML = passwordItem.user;
                    row.cells[2].innerHTML = passwordItem.password;
                    row.cells[3].innerHTML = passwordItem.notes;
                    row.cells[5].innerHTML = passwordItem.modifiedOn.toLocaleString();
                }

                // Clear user input.
                document.getElementById("passwordForm").reset();
            },

            onShowHidePassword: function(e) {
                // // label: row.childNodes[0].firstChild.value,
                // // user: row.childNodes[1].firstChild.value,
                // // password: row.childNodes[2].firstChild.value,
                // // notes: row.childNodes[3].firstChild.value
                // var showHideCheckbox = e.target;
                // var row = e.target.parentNode.parentNode;

                // row.childNodes[1].firstChild.type = showHideCheckbox.checked ? "text" : "password";
                // row.childNodes[2].firstChild.type = showHideCheckbox.checked ? "text" : "password";
            }

            // End: Event Handlers
        };

        function loadKeyHandler(e) {
            var files = e.target.files;

            document.getElementById("fileKeyLoading").innerHTML = "Loading...";

            if (files && files.length > 0) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var fileArrayBuffer = e.target.result;

                    window.crypto.subtle.digest("SHA-256", fileArrayBuffer)
                        .then(function (result) {
                            
                            crypto.subtle.importKey(
                                    "raw",
                                    result,
                                    "AES-CBC",
                                    false,
                                    ["encrypt", "decrypt"])
                                .then(function (key) {
                                    _keyFile = key;

                                    document.getElementById("fileKeyLoading").innerHTML = "";
                                })
                                .catch(function (error) {
                                    alert("error importing key!");
                                });

                        })
                        .catch(function (error) {
                            alert("error loading key!");
                        });

                    window.crypto.subtle.digest("SHA-1", fileArrayBuffer)
                        .then(function (result) {
                            _iv = new Uint8Array(result, 4, 16);
                        })
                        .catch(function (error) {
                            alert("error loading key!");
                        });
                };
                reader.readAsArrayBuffer(files[0]);
            }
        }

        function loadDataHandler(e) {
            var files = e.target.files;

            if (files && files.length > 0) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    deserializeData(e.target.result);
                };
                reader.readAsArrayBuffer(files[0]);
            }
        }

        function deserializeData(buffer) {
            decryptData(buffer, function(text) {
                if (text) {
                    var data = JSON.parse(text);

                    for (var i = 0; i < data.list.length; ++i) {
                        newPasswordRow(data.list[i]);
                    }
                }
            });
        }

        function saveDataHandler(e) {
            var data = serializeData();
            encryptData(data, function(encrypted) {
                saveData("passlist.dat", encrypted);
            });
        }

        function serializeData() {
            var data = {
                list: []
            };
            var rows = document.querySelectorAll("#passwordList tbody tr");
            
            for(var i = 0; i < rows.length; ++i) {
                var row = rows[i];
                data.list.push({
                    label: row.childNodes[0].firstChild.value,
                    user: row.childNodes[1].firstChild.value,
                    password: row.childNodes[2].firstChild.value,
                    notes: row.childNodes[3].firstChild.value
                });
            }

            return JSON.stringify(data);
        }

        function decryptData(encrypted, onDone) {
            window.crypto.subtle.decrypt(
                {
                    name: "AES-CBC",
                    iv: _iv,
                },
                _keyFile,
                encrypted
            )
            .then(function (decrypted) {
                onDone(ab2str(decrypted));
            })
            .catch(function (err) {
                console.error(err);
            });
        }

        function encryptData(serializedData, onDone) {
            var data = str2ab(serializedData);

            window.crypto.subtle.encrypt(
                    {
                        name: "AES-CBC",
                        iv: _iv,
                    },
                    _keyFile,
                    data
                )
                .then(function (encrypted) {
                    onDone(encrypted);
                })
                .catch(function (err) {
                    console.error(err);
                });
        }

        // link: https://stackoverflow.com/questions/3665115/create-a-file-in-memory-for-user-to-download-not-through-server
        function saveData(filename, arrayBuffer) {
            var element = document.createElement('a');
            element.setAttribute('href', window.URL.createObjectURL(new Blob([arrayBuffer])));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // link: https://developers.google.com/web/updates/2012/06/How-to-convert-ArrayBuffer-to-and-from-String
        function ab2str(buf) {
            return String.fromCharCode.apply(null, new Uint16Array(buf));
        }
        function str2ab(str) {
            var buf = new ArrayBuffer(str.length * 2); // 2 bytes for each char
            var bufView = new Uint16Array(buf);
            for (var i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }

        window.onload = function() {
            document.getElementById("addPassword")
                .addEventListener("click", _view.onAddPassword, false);

            document.getElementById("applyEditPassword")
                .addEventListener("click", _view.onApplyEditPassword, false);

            document.getElementById("fileData")
                .addEventListener("change", loadDataHandler, false);

            document.getElementById("fileKey")
                .addEventListener("change", loadKeyHandler, false);

            document.getElementById("saveData")
                .addEventListener("click", saveDataHandler, false);
        }
    </script>
</head>
<body>
    <p>
        <label>Key File</label>
        <input id="fileKey" type="file" />
        <span id="fileKeyLoading"></span>
        <br />
        <label>Data File</label>
        <input id="fileData" type="file" />
    </p>
    <p>
        <form id="passwordForm">
            <input id="passwordFormId" type="hidden" />
            <input id="passwordFormIndex" type="hidden" />
            <label>Label</label>
            <input id="passwordFormLabel" type="text" />
            <br />
            <label>User</label>
            <input id="passwordFormUser" type="text" />
            <br />
            <label>Password</label>
            <input id="passwordFormPassword" type="text" />
            <br />
            <label>Notes</label>
            <textarea id="passwordFormNotes"></textarea>
        </form>
        <button id="addPassword">Add</button>
        <button id="applyEditPassword">Apply Edit</button>
    </p>
    <p>
        <button id="saveData">Save Data</button>
        <table id="passwordList">
            <thead>
                <tr>
                    <th>Label</th>
                    <th>User</th>
                    <th>Password</th>
                    <th>Notes</th>
                    <th>Created On</th>
                    <th>Modified On</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </p>
</body>
</html>